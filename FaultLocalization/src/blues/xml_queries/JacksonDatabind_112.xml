<?xml version="1.0" encoding="ISO-8859-1"?>
<bugrepository name="Defects4J">
<bug id="JacksonDatabind_112" link="https://github.com/FasterXML/jackson-databind/issues/2324">
<buginformation>
<summary>fails  with  custom  collection</summary>
<description>edited seeing this with jackson have custom collection implementation which wired use its immutable version for deserialization the rationale that don want accidental modifications the data structures that come from the wire they all are forced immutable after upgrade from the deserialization started breaking with the message cannot construct instance xxx although least one creator exists default arguments constructor found this happens only when you deserialize custom collection strings property the other object deserializing the custom collection strings directly works fine and does the deserialization custom collection non strings believe either the string collection deserializer should not invoked for custom collections perhaps does not handle the delegation expected please see comments for repro and workaround thanks the text was updated successfully but these errors were encountered copy link author dbarvitsky commented may 2019 here the unit test code that reproduces the problem only test deserialize bag strings fails for assume you have custom collection json deserialize immutable bag class public interface bag extends collection deserialized immutable version add remove etc public static class immutable bag extends abstract collection implements bag override public iterator iterator return elements iterator override public int size return elements size json creator mode json creator mode delegating private immutable bag collection elements this elements collections unmodifiable collection elements private final collection elements public static class value public value string value this value value private string value this does not work see link test deserialize bag strings public static class with bag strings public bag string get strings return this bag strings public void set strings bag string bag strings this bag strings bag strings private bag string bag strings this does work see link test deserialize bag objects public static class with bag values public bag value get values return this bag values public void set values bag value bag values this bag values bag values private bag value bag values test public void test deserialize bag strings throws exception object mapper mapper new object mapper with bag strings result mapper reader for with bag strings class read value strings fails with com fasterxml jackson databind exc mismatched input exception cannot construct instance immutable bag although least one creator exists default arguments constructor found source string strings line column through reference chain with bag strings strings com fasterxml jackson databind exc mismatched input exception from mismatched input exception java com fasterxml jackson databind deserialization context report input mismatch deserialization context java 1343 com fasterxml jackson databind deserialization context handle missing instantiator deserialization context java 1032 com fasterxml jackson databind deser value instantiator create using default value instantiator java 189 com fasterxml jackson databind deser std std value instantiator create using default std value instantiator java 267 com fasterxml jackson databind deser std string collection deserializer deserialize string collection deserializer java 168 com fasterxml jackson databind deser std string collection deserializer deserialize string collection deserializer java com fasterxml jackson databind deser impl method property deserialize and set method property java 127 com fasterxml jackson databind deser bean deserializer vanilla deserialize bean deserializer java 288 com fasterxml jackson databind deser bean deserializer deserialize bean deserializer java 151 com fasterxml jackson databind object reader bind and close object reader java 1611 com fasterxml jackson databind object reader read value object reader java 1219 assert assert equals result get strings size test public void test deserialize bag objects throws exception object mapper mapper new object mapper with bag values result mapper reader for with bag values class read value values assert assert equals result get values size test public void test bag strings alone throws exception curiously this does work too object mapper mapper new object mapper bag string result mapper reader for bag class read value assert assert equals result size copy link author dbarvitsky commented may 2019 workaround understandably less than desirable nail the custom deserializer through the object mapper configuration perhaps there are more elegant ways but just customized the delegating deserializer object mapper mapper new object mapper mapper register module new simple module this add deserializer immutable bag class new std delegating deserializer immutable bag new converter collection immutable bag override public immutable bag convert collection value return new immutable bag value override public java type get input type type factory type factory return type factory construct collection like type collection class object class override public java type get output type type factory type factory return type factory construct collection like type immutable bag class object class override public json deserializer create contextual deserialization context ctxt bean property property throws json mapping exception slightly modified version the original implementation first already got deserializer delegate contextualize delegate deserializer null json deserializer deser ctxt handle secondary contextualization delegate deserializer property delegate type deser delegate deserializer return with delegate converter delegate type deser return this otherwise figure out what the fully generic delegate type then find deserializer java type delegate type ctxt get type factory construct collection like type collection class property get type get bindings get bound type return with delegate converter delegate type ctxt find contextual value deserializer delegate type property override protected std delegating deserializer immutable bag with delegate converter object immutable bag converter java type delegate type json deserializer delegate deserializer return new std delegating deserializer converter delegate type delegate deserializer cowtowncoder added the label may 2019 copy link member cowtowncoder commented may 2019 thank you for reporting this seems like bug cowtowncoder added the active label may 2019 copy link member cowtowncoder commented may 2019 interesting can reproduce the issue presented and the problem seems with jackson special handling for string valued collections there minor performance benefit for case where default string deserializer call can avoided but this case probably need skip that since there custom creator involved copy link member cowtowncoder commented may 2019 interesting this may due 1010 which added separation between regular and array delegator creators that would have been occasionally find places where only former supported since earlier there wasn array variant cowtowncoder added and removed active labels may 2019 cowtowncoder added this the milestone may 2019 cowtowncoder changed the title string collection deserializer fails with custom collection string collection deserializer fails with custom collection may 2019 cowtowncoder closed this 8bb may 2019 copy link author dbarvitsky commented may 2019 cowtowncoder thanks appreciate the quick turnaround please let know you need any help with validating the fix meanwhile here slightly improved although longer version the workaround that handles edge cases like raw types and situations where the collection argument type cannot infer from context better public abstract class generic collection deserializer extends collection super extends std deserializer implements resolvable deserializer contextual deserializer protected generic collection deserializer class extends collection class super class this delegated collection info null override public json deserializer create contextual deserialization context ctxt bean property property throws json mapping exception this delegated collection info null this delegated collection info specific recalculate the delegated collection info attempt infer the types from the property this delegated collection info new delegated collection info ctxt property final java type the collection type this delegated collection info collection type return new std delegating deserializer new converter object override public convert object value return generic collection deserializer this convert collection value override public java type get input type type factory type factory return raw collection type override public java type get output type type factory type factory return the collection type the collection type this delegated collection info collection deserializer override public deserialize json parser deserialization context ctxt throws exception since always return contextually created deserializer this should never called consider this fallback implementation final collection inner delegated collection info null inner delegated collection info collection deserializer deserialize ctxt else inner ctxt read value raw collection type return convert inner override public void resolve deserialization context ctxt throws json mapping exception attempt infer the underlying collection type from context raw collection type ctxt get type factory construct raw collection type collection class delegated collection info new delegated collection info ctxt null protected abstract convert collection input private class delegated collection info public final json deserializer extends collection collection deserializer public final java type collection type public final java type collection arg type delegated collection info deserialization context ctxt bean property property throws json mapping exception java type collection type null java type arg type null json deserializer deserializer null property null arg type get first type parameter property get type else arg type get first type parameter ctxt get contextual type arg type null collection type ctxt get type factory construct collection type collection class arg type deserializer ctxt find root value deserializer collection type else collection type raw collection type deserializer ctxt find root value deserializer collection type deserializer null throw json mapping exception from ctxt string format cannot find deserializer read collection type collection type this collection type collection type this collection arg type arg type this collection deserializer deserializer assert this collection type null assert this collection deserializer null public boolean specific return this collection arg type null private java type get first type parameter java type expr expr null type bindings arg bindings expr get bindings arg bindings null arg bindings empty return arg bindings get bound type return null private delegated collection info delegated collection info private java type raw collection type this can used follows json deserialize using immutable bag deserializer class public static class immutable bag extends abstract collection implements bag public static class deserializer extends generic collection deserializer immutable bag public deserializer super immutable bag class override public immutable bag convert collection value return new immutable bag value copy link member cowtowncoder commented may 2019 just make sure don think you should need any this long deserializer accessed via deserializers method find collection deserializer collection type given will have fully resolved type accessible should necessary try access type via bean property from create contextual that should only needed access other annotations needed sign for free join this conversation git hub already have account sign comment assignees one assigned labels none yet projects none yet milestone linked pull requests successfully merging pull request may close this issue none yet participants</description>
</buginformation>
<fixedfiles>
<file>com.fasterxml.jackson.databind.deser.std.StringCollectionDeserializer</file>
</fixedfiles>
</bug>
</bugrepository>
