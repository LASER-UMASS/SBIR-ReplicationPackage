<?xml version="1.0" encoding="ISO-8859-1"?>
<bugrepository name="Defects4J">
<bug id="Compress_9" link="https://issues.apache.org/jira/browse/COMPRESS-160">
<buginformation>
<summary>tar archive output stream get bytes written  returns  invalid  value</summary>
<description>appears  the  tararchiveoutputstream  getbyteswritten  returns  zero  invalid  value  when  queried  the  code  sample  below  returns  zero  even  after  sizeable  file  was  processed  printed  twice  once  before  closing  the  output  stream  and  once  after  just  for  the  reference  also  demonstrable  multiple  processed  files  within  the  tararchiveoutputstream  getbyteswritten  implementation  appears  the  call  for  count  numtowrite  made  after  the  numtowrite  depleted  the  process  actual  byte  writing  when  call  for  count  numtowrite  moved  the  returned  values  for  tararchiveoutputstream  getbyteswritten  are  getting  equal  the  sum  the  sizes  processed  files  this  much  closer  expected  value  returns  the  current  number  bytes  written  this  stream  but  still  not  correct  for  that  number  should  include  the  tar  header  sizes  well  any  rate  please  find  the  proposed  patch  below  merely  moving  count  numtowrite  few  lines  this  makes  tararchiveoutputstream  getbyteswritten  closer  true  value  test  code  test  public  void  tartest  throws  exception  fileoutputstream  myoutputstream  new  fileoutputstream  temp  tartest  tar  archiveoutputstream  starout  new  archivestreamfactory  createarchiveoutputstream  archivestreamfactory  tar  myoutputstream  file  ssource  new  file  share  txt  tararchiveentry  sentry  new  tararchiveentry  ssource  starout  putarchiveentry  sentry  fileinputstream  sinput  new  fileinputstream  ssource  byte  cpread  new  byte  8192  int  iread  while  iread  sinput  read  cpread  starout  write  cpread  iread  slog  info  processed  starout  getbyteswritten  bytes  file  len  ssource  length  sinput  close  starout  closearchiveentry  starout  close  slog  info  processed  starout  getbyteswritten  bytes  file  len  ssource  length  return  test  output  oct  2011  com  cronsult  jndmpd  test  backup  tartest  info  processed  bytes  file  len  186974208  oct  2011  com  cronsult  jndmpd  test  backup  tartest  info  processed  bytes  file  len  186974208  proposed  patch  index  src  main  java  org  apache  commons  compress  archivers  tar  tararchiveoutputstream  java  src  main  java  org  apache  commons  compress  archivers  tar  tararchiveoutputstream  java  revision  1187150  src  main  java  org  apache  commons  compress  archivers  tar  tararchiveoutputstream  java  working  copy  276  276  eliminate  some  the  buffer  copying  count  numtowrite  assemlen  assemlen  numtowrite  recordbuf  length  325  327  woffset  num  count  numtowrite</description>
</buginformation>
<fixedfiles>
<file>org.apache.commons.compress.archivers.tar.TarArchiveOutputStream</file>
</fixedfiles>
</bug>
</bugrepository>
