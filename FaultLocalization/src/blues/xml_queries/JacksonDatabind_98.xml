<?xml version="1.0" encoding="ISO-8859-1"?>
<bugrepository name="Defects4J">
<bug id="JacksonDatabind_98" link="https://github.com/FasterXML/jackson-databind/issues/1328">
<buginformation>
<summary>external  property  polymorphic  deserialization  does  not  work  with  enums</summary>
<description>edited versions jackson jackson module kotlin attempting deserialize class using external property case the property enum type with values matching the type name now that issue 999 fixed thought this would work but now getting different error exception thread main com fasterxml jackson databind json mapping exception can not construct instance enum invite problem argument type mismatch source kind contact name foo line column com fasterxml jackson databind json mapping exception from json mapping exception java 268 com fasterxml jackson databind deserialization context instantiation exception deserialization context java 1405 com fasterxml jackson databind deser std std value instantiator wrap json mapping exception std value instantiator java 468 com fasterxml jackson databind deser std std value instantiator rewrap ctor problem std value instantiator java 487 com fasterxml jackson databind deser std std value instantiator create from object with std value instantiator java 276 com fasterxml jackson module kotlin kotlin value instantiator create from object with kotlin value instantiator com fasterxml jackson databind deser impl property based creator build property based creator java 135 com fasterxml jackson databind deser impl external type handler complete external type handler java 225 com fasterxml jackson databind deser bean deserializer deserialize using property based with external type bean deserializer java 937 com fasterxml jackson databind deser bean deserializer deserialize with external type bean deserializer java 792 com fasterxml jackson databind deser bean deserializer deserialize from object bean deserializer java 312 com fasterxml jackson databind deser bean deserializer deserialize bean deserializer java 148 com fasterxml jackson databind object mapper read map and close object mapper java 3789 com fasterxml jackson databind object mapper read value object mapper java 2852 enum reproduction kind enum main reproduction kind enum sun reflect native method accessor impl invoke native method sun reflect native method accessor impl invoke native method accessor impl java sun reflect delegating method accessor impl invoke delegating method accessor impl java java lang reflect method invoke method java 498 com intellij execution application app main main app main java 147 caused java lang illegal argument exception argument type mismatch sun reflect native constructor accessor impl new instance native method sun reflect native constructor accessor impl new instance native constructor accessor impl java sun reflect delegating constructor accessor impl new instance delegating constructor accessor impl java java lang reflect constructor new instance constructor java 423 com fasterxml jackson databind introspect annotated constructor call annotated constructor java 124 com fasterxml jackson databind deser std std value instantiator create from object with std value instantiator java 274 more process finished with exit code here the reproduction recipe https github com rocketraman jackson issue enum polymorphism blob master src main kotlin enumtype reproduction kind enum the text was updated successfully but these errors were encountered rocketraman mentioned this issue aug 2016 external property deserialized even visible false 1329 open copy link member apatrida commented sep 2016 this one odd basically the subclass std value instantiator create from object with function receives the buffer property value buffer parameter when calling buffer get parameters props first parameter type string that contact and second that type invite contact that correct and this stored local variablejson parm value list then the kotlin value instantiator this case just delegates super create from object with ctxt json parm value list which blows with this exception tries create the object with the wrong datatype for the first parameter string instead the invite kind enum and causes this exception that doesn appear problem the kotlin module which doesn handle this case and just delegates although think didn would blow differently because would still have the wrong type copy link member apatrida commented sep 2016 the bug that the type the polymorphic variable coming string instead the enum type and therefore cannot used create the object argument type mismatch the constructor fails when databind code does the instantiation and when have the kotlin module the same fails well maybe only applies when value instantiator being used that always used std value instantiator cowtowncoder copy link member apatrida commented sep 2016 you can test running the kotlin module after enabling the test https github com faster xml jackson module kotlin blob master src test kotlin com fasterxml jackson module kotlin test github databind 1328 copy link member cowtowncoder commented sep 2016 would need java only reproduction here since sounds there nothing kotlin specific about copy link member cowtowncoder commented sep 2016 this basically 1366 copy link author rocketraman commented sep 2016 apatrida cowtowncoder was not able reproduce this java here the java repro attempt https github com rocketraman jackson issue enum polymorphism blob master src main java enumtype java reproduction kind enum java copy link member apatrida commented sep 2016 rocketraman not sure basically receive value the wrong type string when should coerced the enum value already could still issue with the std value instantiator check again copy link member apatrida commented sep 2016 cowtowncoder the issue std value instantiator and hard reproduce java because the default constructor called and then values are set after which point they have the correct type but value instantiator play then this code will break override public object create from object with deserialization context ctxt settable bean property props property value buffer buffer object json parm value list buffer get parameters props super create from object with ctxt json parm value list and looking the object parameters received because the enum comes type string and not enum type whereas this set via property rocketraman attempt reproduce java then comes the enum type which doesn crash something the property value buffer class does not know what type coerce the value into looking the method signature again the settable bean property props parameter should have the properties with their correct types right and does have properties that come simple type class com fasterxml jackson module kotlin test github databind 1328 invite kind simple type class com fasterxml jackson module kotlin test github databind 1328 invite great those are correct why then does buffer get parameters props return contact string invite contact name foo invite contact therefore buffer get parameters databind does not coerce the string contact into enum should the issue lies there not sure how java you can force the std value instantiator used reproduce this copy link member apatrida commented sep 2016 looking the work from 1224 would help figure out how reproduce this from java since there were test cases written for this rocketraman copy link member apatrida commented sep 2016 and goes deeper whatever created the property value buffer instance put the wrong type begin with since creator parameters contains the string instead enum well copy link member apatrida commented sep 2016 edited public boolean assign parameter settable bean property prop object value final int prop get creator index creator parameters value value wrong type but prop correct type the value passed into property value buffer assign parameter wrong type who job coerce the type from string into enum cowtowncoder copy link member apatrida commented sep 2016 can work around the issue special casing string enum conversion but then the normal std value instantiator will still fail only fix the kotlin case copy link member cowtowncoder commented oct 2016 apatrida hadn noticed your second last comment think really need smallish example follow through know who right who wrong copy link pmorixe commented mar 2017 edited cowtowncoder have the same issue think its issue after upgrading from java spring boot project using enum external property the instantiation polymorphic variable its right set but the type variable enum type that its correctly mapped object creation the args comes string json type obj public class object type type json type info property type include external property use name json sub types json sub types type value class name json sub types type value class name interface obj enum type class implements interface class implements interface cowtowncoder added the label mar 2017 copy link member cowtowncoder commented apr 2017 edited looking this again now realize that not clear whether type even expected allow anything other than strings never intended used for anything other than simple strings for what that worth has worked that actually surprising but try see easy make this work not unreasonable wish copy link member cowtowncoder commented apr 2017 pmorixe unfortunately still don see the issue here exception thrown what the exact problem you see note that type metadata only default its value should not visible properties unless visible true set for json type info but even that done not see failure think like see some assertion test tested this with but don assume this different from copy link member cowtowncoder commented apr 2017 apatrida conversion expected value property should done jackson databind when buffering possible not possible only tokens token buffer should buffered and value deserialized cowtowncoder added commit that referenced this issue apr 2017 add test for 1328 not failing alas loading status checks 520cdba copy link member cowtowncoder commented sep 2017 unfortunately can not reproduce this point may opened filed with java reproduction cowtowncoder closed this sep 2017 copy link luke butters commented may 2018 edited also ran into this problem noticed that when came time call the all argument constructor set include json type info external property jackson would try pass string rather than enum tried break down into something small demonstrate this problem and found out the issue lombok adds java beans constructor properties type animal the all args constructor manually make the constructor with that annotation fails remove works here code that demonstrates the problem import java util arrays import java util list import org junit test import java exception import com fasterxml jackson annotation json type info import com fasterxml jackson annotation json type info import com fasterxml jackson databind databind context import com fasterxml jackson databind java type import com fasterxml jackson databind object mapper import com fasterxml jackson databind annotation json type resolver import com fasterxml jackson databind jsontype type resolver import com fasterxml jackson databind type type factory public class enum failure example public interface animal public static class dog implements animal private string dog stuff public dog public dog string dog stuff this dog stuff dog stuff public string get dog stuff return dog stuff public void set dog stuff string dog stuff this dog stuff dog stuff public enum amimal type dog public static class animal and type private amimal type type json type info use json type info class include json type info external property property type json type resolver animal resolver class private animal animal public animal and type problem this annotation java beans constructor properties type animal public animal and type final amimal type type final animal animal this type type this animal animal public amimal type get type return type public void set type amimal type type this type type public animal get animal return animal public void set animal animal animal this animal animal public static class animal resolver implements type resolver private java type base type override public void init java type base type this base type base type override public string from value object value its external why this called return null override public string from value and type object value class suggested type its external why this called return null override public string from base type throw new unsupported operation exception missing action type information can not construct override public java type type from databind context context string throws exception class clazz null amimal type dog string equals clazz dog class else throw new illegal argument exception what return type factory default instance construct specialized type base type clazz override public string get desc for known type ids return null override public get mechanism return custom test public void test example throws exception object mapper mapper new object mapper byte bytes mapper writer with default pretty printer write value bytes arrays list new animal and type amimal type dog new dog system out println new string bytes mapper read value bytes mapper get type factory construct collection type list class animal and type class this using jackson copy link member cowtowncoder commented may 2018 lombok unfortunately often part problem possible here due its adding constructor parameters which both names the constructor parameters and indicates creator active constructor use but possible disable latter part disabling mapper feature infer creator from constructor properties which might prevent the issue copy link luke butters commented may 2018 thanks that useful know yes due the constructor parameters annotation was able remove lombok and just have that annotation and the problem showed what should done next think this bug would you like new issue created should this opened copy link member cowtowncoder commented may 2018 luke butters funnelback how about open given that there java reproduction cowtowncoder reopened this may 2018 cowtowncoder added the active label may 2018 cowtowncoder removed the active label jun 2018 cowtowncoder added this the milestone jun 2018 cowtowncoder closed this 12f 82c jun 2018 copy link member cowtowncoder commented jun 2018 this took while but found the problem and fixed for apatrida pointed out earlier value was wrong type string and needs routed via deserializer first added into temporary buffer doing that resolves this case least did not see other code paths hope this sufficient sign for free join this conversation git hub already have account sign comment assignees one assigned labels none yet projects none yet milestone linked pull requests successfully merging pull request may close this issue none yet participants</description>
</buginformation>
<fixedfiles>
<file>com.fasterxml.jackson.databind.deser.impl.ExternalTypeHandler</file>
</fixedfiles>
</bug>
</bugrepository>
